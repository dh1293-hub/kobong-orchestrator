# scripts/run-contract-tests.ps1 — clean
# PS-GUARD-BOOTSTRAP v1
$ErrorActionPreference = 'Stop'
Set-StrictMode -Version Latest
Write-Host '[WARN] Continuous PowerShell session — follow GPT-5 steps only.' -ForegroundColor DarkYellow

# 경로/루트
$RepoRoot = Split-Path -Parent $PSScriptRoot
[Environment]::CurrentDirectory = $RepoRoot

# PYTHONPATH 보강(세퍼레이터 안전)
$sep   = [System.IO.Path]::PathSeparator
if ([string]::IsNullOrWhiteSpace($env:PYTHONPATH)) {
  $env:PYTHONPATH = $RepoRoot
} else {
  $parts = $env:PYTHONPATH -split [regex]::Escape([string]$sep)
  if ($parts -notcontains $RepoRoot) { $env:PYTHONPATH = "$RepoRoot$sep$($env:PYTHONPATH)" }
}

# (선택) 환경 스크립트
if (Test-Path "$PSScriptRoot\setup-env.ps1") {
  & "$PSScriptRoot\setup-env.ps1"
}

# Python 선택
$py = Join-Path $RepoRoot '.venv\Scripts\python.exe'
if (-not (Test-Path -LiteralPath $py)) { $py = 'python' }

# 사전 임포트 점검(PS 호환: -c 단일 문자열)
& $py -c "import sys; print('[PY] sys.path0:', sys.path[0]); import infra, infra.logging.json_logger as jl; print('[PY] import infra OK')"

# 테스트 실행
& $py -m pytest -q tests/contract
