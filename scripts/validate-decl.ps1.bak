$ErrorActionPreference='Stop'
param()
# Utility 모듈 시도(없어도 무시)
Import-Module Microsoft.PowerShell.Utility -ErrorAction SilentlyContinue | Out-Null

# 루트 결정
$root = $env:HAN_GPT5_ROOT
if (-not $root) { $root = (Resolve-Path "$PSScriptRoot\..").Path }

$yaml = Join-Path $root 'project.decl.yaml'
$json = Join-Path $root 'project.decl.json'

$decl = $null
if (Get-Command ConvertFrom-Yaml -ErrorAction SilentlyContinue) {
  if (Test-Path $yaml) { $decl = Get-Content $yaml -Raw | ConvertFrom-Yaml }
}
if (-not $decl -and (Test-Path $json)) {
  $decl = Get-Content $json -Raw | ConvertFrom-Json
}
if (-not $decl) { throw 'PRECONDITION: declaration parse failed (need ConvertFrom-Yaml or project.decl.json).' }

if ($decl.decl_version -ne 1) { throw 'Unsupported decl_version' }
if (-not $decl.paths.root_env) { throw 'paths.root_env required' }

$rootEnvName = $decl.paths.root_env
if (-not [Environment]::GetEnvironmentVariable($rootEnvName, 'Process')) {
  [Environment]::SetEnvironmentVariable($rootEnvName, $root, 'Process')
}

$rootFromEnv = [Environment]::GetEnvironmentVariable($rootEnvName, 'Process')
if (-not $rootFromEnv) { throw "ENV not set: $rootEnvName" }

$paths = @('out','logs','cache','tmp') | ForEach-Object { Join-Path $rootFromEnv $decl.paths.$_ }
foreach ($p in $paths) { if (-not (Test-Path $p)) { New-Item -ItemType Directory -Force -Path $p | Out-Null } }

Write-Host '[OK] declaration validated'
