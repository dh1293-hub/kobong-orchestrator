# APPLY IN SHELL
#requires -Version 7.0
param([switch]$ConfirmApply,[string]$Root)
Set-StrictMode -Version Latest
$ErrorActionPreference='Stop'
$PSDefaultParameterValues['Out-File:Encoding']='utf8'
$PSDefaultParameterValues['*:Encoding']='utf8'
if ($env:CONFIRM_APPLY -eq 'true') { $ConfirmApply = $true }

# === Preflight ===
$RepoRoot = if ($Root) { (Resolve-Path -LiteralPath $Root).Path } else { (git rev-parse --show-toplevel 2>$null) ?? (Get-Location).Path }
if (-not (Test-Path $RepoRoot)) { Write-Error "PRECONDITION: RepoRoot not found â†’ $RepoRoot"; exit 10 }
Set-Location $RepoRoot
$Branch = (git rev-parse --abbrev-ref HEAD 2>$null) ?? '<unknown>'
$now = [TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date),'Asia/Seoul').ToString('yyyy-MM-dd HH:mm:ss')
Write-Host ("`n[verify] PS7 headers on {0} @ {1} (KST)" -f $Branch,$now)

# ì „ìš© ë½
$LockFile = Join-Path $RepoRoot '.gpt5.lock.ps7-headers'
if (Test-Path $LockFile) { Write-Error 'CONFLICT: .gpt5.lock.ps7-headers exists.'; exit 11 }
"locked $(Get-Date -Format o)" | Out-File $LockFile -Encoding utf8 -NoNewline
$sw=[Diagnostics.Stopwatch]::StartNew()
$trace=[guid]::NewGuid().ToString()
function Write-Log($level,$action,$message,$outcome='',$errorCode='',$inputHash=''){
  $rec=[ordered]@{timestamp=(Get-Date).ToString('o');level=$level;traceId=$trace;module='ps7-guard';action=$action;inputHash=$inputHash;outcome=$outcome;durationMs=$sw.ElapsedMilliseconds;errorCode=$errorCode;message=$message}|ConvertTo-Json -Compress
  $log=Join-Path $RepoRoot 'logs/apply-log.jsonl'; New-Item -ItemType Directory -Force -Path (Split-Path $log)|Out-Null; Add-Content -Path $log -Value $rec
}

# ìš”êµ¬ í—¤ë”(í‘œì¤€ ê°€ì´ë“œ)
$RequiredHeader = @(
  "#requires -Version 7.0",
  "param([switch]`$ConfirmApply,[string]`$Root)",
  "Set-StrictMode -Version Latest",
  "`$ErrorActionPreference='Stop'",
  "`$PSDefaultParameterValues['Out-File:Encoding']='utf8'",
  "`$PSDefaultParameterValues['*:Encoding']='utf8'",
  "if (`$env:CONFIRM_APPLY -eq 'true') { `$ConfirmApply = `$true }"
) -join "`n"

# ê²€ì‚¬ ì •ê·œì‹(ì‘ì€ë”°ì˜´í‘œ ì‚¬ìš© â†’ ë³€ìˆ˜/ë°±ìŠ¬ë˜ì‹œ ì•ˆì „)
$rxRequires = [regex]'(?m)^\s*#requires\s+-Version\s+7(\.0+)?\s*$'
$rxStrict   = [regex]'(?m)^\s*Set-StrictMode\s+-Version\s+Latest\s*$'
$rxEAP      = [regex]'(?m)^\s*\$ErrorActionPreference\s*=\s*''Stop''\s*$'
$rxParam    = [regex]'(?m)^\s*param\s*\(\s*\[switch\]\$ConfirmApply.*\[string\]\$Root.*\)\s*$'
$rxEnc1     = [regex]'(?m)\$PSDefaultParameterValues\[''Out-File:Encoding''\]\s*=\s*''utf8'''
$rxEnc2     = [regex]'(?m)\$PSDefaultParameterValues\[''\*:Encoding''\]\s*=\s*''utf8'''
$rxEnv      = [regex]'(?m)if\s*\(\s*\$env:CONFIRM_APPLY\s*-eq\s*''true''\s*\)\s*\{\s*\$ConfirmApply\s*=\s*\$true\s*\}'

# ìŠ¤í‚µ ê·œì¹™(í´ë”/ìê¸°ìì‹ )
$skipRx = [regex]'(?i)[/\\](?:\.git|node_modules|dist|out|coverage|\.venv|\.pytest_cache|\.idea|\.vscode)(?:[/\\]|$)'
$files = Get-ChildItem -Recurse -File -Include *.ps1,*.psm1 | Where-Object {
  -not $skipRx.IsMatch($_.FullName)
}
$files = $files | Where-Object { $_.FullName -ne $PSCommandPath }  # self-skip

# ìŠ¤ìº”
$plan = @()
foreach ($f in $files) {
  $txt = Get-Content -Raw -Encoding utf8 $f.FullName
  $missing = @()
  if (-not $rxRequires.IsMatch($txt)) { $missing += '#requires' }
  if (-not $rxParam.IsMatch($txt))    { $missing += 'param(ConfirmApply,Root)' }
  if (-not $rxStrict.IsMatch($txt))   { $missing += 'Set-StrictMode' }
  if (-not $rxEAP.IsMatch($txt))      { $missing += 'ErrorActionPreference' }
  if (-not $rxEnc1.IsMatch($txt))     { $missing += "PSDefault Out-File:Encoding" }
  if (-not $rxEnc2.IsMatch($txt))     { $missing += "PSDefault *:Encoding" }
  if (-not $rxEnv.IsMatch($txt))      { $missing += 'CONFIRM_APPLY bridge' }

  if ($missing.Count -gt 0) {
    $plan += [pscustomobject]@{ Path=$f.FullName; Missing=$missing -join ', ' }
  }
}

if (-not $plan) {
  Write-Host "âœ… ëª¨ë“  PowerShell ìŠ¤í¬ë¦½íŠ¸ê°€ PS7 ì•ˆì „ í—¤ë”ë¥¼ ê°–ì¶”ì—ˆìŠµë‹ˆë‹¤."
  Write-Log 'INFO' 'scan' 'all good' 'OK'
  exit 0
}

Write-Host ("ğŸ“ í—¤ë” ëˆ„ë½ íŒŒì¼ {0}ê°œ" -f $plan.Count)
$plan | ForEach-Object { Write-Host (" - {0} :: {1}" -f $_.Path, $_.Missing) }

if (-not $ConfirmApply) {
  Write-Host "`nDRY-RUN âœ… ì‹¤ì œ ìˆ˜ì •ì€ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
  Write-Host "ì ìš©í•˜ë ¤ë©´:"
  Write-Host "  `$env:CONFIRM_APPLY='true'; pwsh -File scripts/g5/guard-ps7-header.ps1 -ConfirmApply"
  Write-Log 'INFO' 'dryrun' ("would fix {0} files" -f $plan.Count) 'NOT_APPLIED'
  exit 0
}

# === Apply: í—¤ë” ìë™ ì‚½ì…(ë°±ì—…+ì›ìêµì²´) ===
$ts = Get-Date -Format 'yyyyMMdd-HHmmss'
foreach ($it in $plan) {
  $p = $it.Path
  $src = Get-Content -Raw -Encoding utf8 $p
  $new = ($RequiredHeader + "`n`n" + $src)
  $bak = "$p.bak-$ts"
  Copy-Item $p $bak -Force
  $tmp = "$p.tmp"
  Set-Content -Path $tmp -Value $new -Encoding utf8 -NoNewline
  Move-Item -Force $tmp $p
  Write-Log 'INFO' 'apply' "inserted header â†’ $p" 'APPLIED' '' ((Get-FileHash -Algorithm SHA256 $p).Hash)
  Write-Host "[fixed] $p â€” backup: $bak"
}

Write-Host "`nDONE âœ… í—¤ë” ì‚½ì… ì™„ë£Œ"
exit 0