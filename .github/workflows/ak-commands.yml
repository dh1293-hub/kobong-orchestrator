      # 8) 모드 판별(미리 계산) — preview / apply 플래그 추출
      - name: Decide mode
        id: mode
        shell: bash
        run: |
          args="${{ steps.parse.outputs.args }}"
          lc="$(echo "$args" | tr '[:upper:]' '[:lower:]')"
          # 적용 여부
          if echo " $lc " | grep -q " apply "; then echo "apply=true"  >> $GITHUB_OUTPUT; else echo "apply=false"  >> $GITHUB_OUTPUT; fi
          # 프리뷰 여부 (fixloop + preview)
          if [ "${{ steps.parse.outputs.cmd }}" = "fixloop" ] && echo " $lc " | grep -q " preview "; then
            echo "preview=true" >> $GITHUB_OUTPUT
          else
            echo "preview=false" >> $GITHUB_OUTPUT
          fi

      # 9A) 프리뷰 전용(무조건 성공 처리)
      - name: Run KO via PS7 (preview-safe)
        if: ${{ steps.mode.outputs.preview == 'true' }}
        shell: bash
        run: |
          set +e
          pwsh -NoLogo -NoProfile -File scripts/g5/ak-dispatch.ps1 \
            -Command '${{ steps.parse.outputs.cmd }}' \
            -RawArgs '${{ steps.parse.outputs.args }}' \
            -Sha '${{ github.sha }}' \
            -Pr '${{ github.event.issue.number || github.event.pull_request.number }}'
          code=$?
          echo "[note] preview mode: forcing success (code=$code)"
          echo -e "result=success\ncmd=/ak ${{ steps.parse.outputs.cmd }} ${{ steps.parse.outputs.args }}" >> "$GITHUB_STEP_SUMMARY"
          exit 0

      # 9B) 일반 경로(코드<10 정상화, ≥10은 실패 유지)
      - name: Run KO via PS7 (strict)
        if: ${{ steps.mode.outputs.preview != 'true' }}
        shell: bash
        run: |
          set +e
          pwsh -NoLogo -NoProfile -File scripts/g5/ak-dispatch.ps1 \
            -Command '${{ steps.parse.outputs.cmd }}' \
            -RawArgs '${{ steps.parse.outputs.args }}' \
            -Sha '${{ github.sha }}' \
            -Pr '${{ github.event.issue.number || github.event.pull_request.number }}'
          code=$?
          if [ -z "$code" ]; then code=0; fi
          if [ "$code" -lt 10 ]; then
            echo "[note] normalize exit code $code → 0 (non-fatal)"
            exit 0
          else
            exit "$code"
          fi
