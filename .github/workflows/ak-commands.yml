name: ak-commands

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  run-ak:
    if: ${{ contains(github.event.comment.body, '/ak ') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1) ëª…ë ¹/ì¸ì íŒŒì‹±
      - name: Parse command & args
        id: parse
        shell: bash
        run: |
          body="${{ github.event.comment.body }}"
          cmd=$(echo "$body" | sed -nE 's@.*\/ak[[:space:]]+([a-z0-9\-]+).*@\1@p')
          args=$(echo "$body" | sed -nE 's@.*\/ak[[:space:]]+[a-z0-9\-]+[[:space:]]*(.*)@\1@p')
          echo "cmd=$cmd"   >> $GITHUB_OUTPUT
          echo "args=$args" >> $GITHUB_OUTPUT

      # 2) ê¶Œí•œ ê²Œì´íŠ¸(OWNER/MEMBER/COLLABORATOR í—ˆìš©)
      - name: Check author permission
        id: auth
        shell: bash
        run: |
          assoc="${{ github.event.comment.author_association }}"
          case "$assoc" in
            OWNER|MEMBER|COLLABORATOR) echo "ok=true"  >> $GITHUB_OUTPUT ;;
            *)                         echo "ok=false" >> $GITHUB_OUTPUT ;;
          esac

      # 3) ë¬´ê¶Œí•œì´ë©´ ì•ˆë‚´ ëŒ“ê¸€ í›„ ì¢…ë£Œ
      - name: Reply unauthorized
        if: steps.auth.outputs.ok != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const pr = context.payload.issue?.number || context.payload.pull_request?.number;
            const body = [
              "âš ï¸ ì´ ëª…ë ¹ì€ ì €ì¥ì†Œ **OWNER/MEMBER/COLLABORATOR**ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
              "í•„ìš” ì‹œ ë‹´ë‹¹ìì—ê²Œ ê¶Œí•œ ìš”ì²­ ë˜ëŠ” `/ak help`ë¡œ ì‚¬ìš©ë²•ì„ í™•ì¸í•˜ì„¸ìš”."
            ].join("\n");
            await github.rest.issues.createComment({ owner, repo, issue_number: pr, body });
      - name: Short-circuit when unauthorized
        if: steps.auth.outputs.ok != 'true'
        run: exit 0

      # 4) ë¼ë²¨ ê²Œì´íŠ¸: ak:enabled í•„ìš”(help ì œì™¸)
      - name: Check label gate
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const cmd = '${{ steps.parse.outputs.cmd }}';
            if (cmd === 'help') { core.setOutput('enabled','true'); return; }
            const {owner, repo} = context.repo;
            const pr = context.payload.issue?.number || context.payload.pull_request?.number;
            const {data} = await github.rest.issues.listLabelsOnIssue({owner, repo, issue_number: pr});
            const ok = data.some(l => l.name.toLowerCase() === 'ak:enabled');
            if (!ok) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: pr,
                body: "ğŸ”’ ì‹¤í–‰ ì°¨ë‹¨: ë¼ë²¨ **`ak:enabled`** ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¼ë²¨ ì¶”ê°€ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”. (`/ak help`ëŠ” ë¼ë²¨ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥)"
              });
            }
            core.setOutput('enabled', ok ? 'true' : 'false');

      - name: Short-circuit when label not present
        if: steps.gate.outputs.enabled != 'true'
        run: exit 0

      # 5) í˜¸ì¶œ ëŒ“ê¸€ ACK(ë¦¬ì•¡ì…˜)
      - name: React to invoking comment
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const cid = context.payload.comment.id;
            await github.rest.reactions.createForIssueComment({
              owner, repo, comment_id: cid, content: 'rocket'
            });

      # 6) ì•¼ê°„ ê°€ë“œ(KST 00â€“07) : apply ë¥˜ ì°¨ë‹¨(ë¼ë²¨ë¡œ í•´ì œ)
      - name: Guard quiet hours (KST)
        id: night
        uses: actions/github-script@v7
        with:
          script: |
            const cmd  = '${{ steps.parse.outputs.cmd }}';
            const args = '${{ steps.parse.outputs.args }}';
            const {owner, repo} = context.repo;
            const pr = context.payload.issue?.number || context.payload.pull_request?.number;
            // PR ë¼ë²¨ ê°€ì ¸ì™€ night-override ìœ ë¬´ ì²´í¬
            const {data: labels} = await github.rest.issues.listLabelsOnIssue({owner, repo, issue_number: pr});
            const override = labels.some(l => l.name.toLowerCase() === 'ak:night-override');
            // UTC â†’ KST(+9)
            const hourKST = (new Date().getUTCHours() + 9) % 24;
            const risky = /(fixloop|rewrite)/.test(cmd) && /\bapply\b/.test(args);
            let blocked = false;
            if (!override && risky && (hourKST >= 0 && hourKST < 7)) {
              blocked = true;
              await github.rest.issues.createComment({
                owner, repo, issue_number: pr,
                body: "ğŸŒ™ **ì•¼ê°„ ê°€ë“œ**: KST 00:00â€“07:00ì—ëŠ” `apply` ì‘ì—…ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. " +
                      "`preview`ë¡œ ì ê²€í•˜ê±°ë‚˜ ë¼ë²¨ **`ak:night-override`** ì¶”ê°€ í›„ ì¬ì‹œë„í•˜ì„¸ìš”."
              });
            }
            core.setOutput('blocked', blocked ? 'true' : 'false');

      - name: Short-circuit when quiet hours
        if: steps.night.outputs.blocked == 'true'
        run: exit 0

      # 7) helpë©´ ë§í¬í˜• ë„ì›€ë§ ëŒ“ê¸€ í›„ ì¡°ê¸° ì¢…ë£Œ
      - name: Reply with help (links)
        if: steps.parse.outputs.cmd == 'help'
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const pr = context.payload.issue?.number || context.payload.pull_request?.number;
            const lines = [
              "### AK ëª…ë ¹ ë„ì›€ë§",
              "- `/ak test` â€” í…ŒìŠ¤íŠ¸ ì²´í¬ëŸ° ì‹¤í–‰",
              "- `/ak scan --all` â€” ì „ì²´ ìŠ¤ìº” ë³´ê³ ì„œ",
              "- `/ak fixloop preview` â†’ `/ak fixloop apply` â€” íŒ¨ì¹˜ ë¯¸ë¦¬ë³´ê¸°/ì ìš©",
              "- `/ak rewrite [options]` â€” ì½”ë“œ ì œì•ˆ(ì„œì œìŠ¤íŠ¸)",
              "",
              "> ë¡œê·¸/ì¢…ë£Œì½”ë“œÂ·ë¡¤ë°± ê·œì¹™ì€ í”„ë¡œì íŠ¸ í‘œì¤€(PS7Â·KLCÂ·URS)ì„ ë”°ë¦…ë‹ˆë‹¤."
            ];
            await github.rest.issues.createComment({ owner, repo, issue_number: pr, body: lines.join("\n") });
      - name: Short-circuit when help
        if: steps.parse.outputs.cmd == 'help'
        run: echo "help replied" && exit 0

      # 8) ì‹¤ì œ ë””ìŠ¤íŒ¨ì¹˜(PS7) â€” ì¸ì ì „ë‹¬
      - name: Run KO via PS7
        shell: pwsh
        run: |
          pwsh -NoLogo -NoProfile -File scripts/g5/ak-dispatch.ps1 `
            -Command "${{ steps.parse.outputs.cmd }}" `
            -RawArgs "${{ steps.parse.outputs.args }}" `
            -Sha "${{ github.sha }}" `
            -Pr "${{ github.event.issue.number || github.event.pull_request.number }}"

      # 9) ì‹¤í–‰ ìš”ì•½ ëŒ“ê¸€(í•­ìƒ) + KB ë§í¬
      - name: Comment summary with links
        if: always()
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          CHECKS_URL: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.issue.number || github.event.pull_request.number }}/checks
          CMD: ${{ steps.parse.outputs.cmd }}
          ARGS: ${{ steps.parse.outputs.args }}
          STATUS: ${{ job.status }}
          KB_URL: ${{ github.server_url }}/${{ github.repository }}/blob/main/.kobong/reports/ERROR-KB.md
        with:
          script: |
            const {owner, repo} = context.repo;
            const pr = context.payload.issue?.number || context.payload.pull_request?.number;
            const body = [
              `**/ak ${process.env.CMD} ${process.env.ARGS || ''}** finished: **${process.env.STATUS.toUpperCase()}**`,
              `- Actions Run: ${process.env.RUN_URL}`,
              `- PR Checks  : ${process.env.CHECKS_URL}`,
              `- Error KB   : ${process.env.KB_URL}`
            ].join("\n");
            await github.rest.issues.createComment({ owner, repo, issue_number: pr, body });
