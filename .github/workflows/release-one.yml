name: Release One-Click

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'vX.Y.Z (e.g. v1.0.0)'
        required: true
      notes:
        description: 'Release notes (optional)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1) 버전 형식+중복 확인 (GitHub API 사용)
      - name: Validate version & uniqueness (API)
        id: chk
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ver = core.getInput('version', { required: true });
            if (!/^v\d+\.\d+\.\d+$/.test(ver)) {
              core.setFailed(`bad version: ${ver}`);
              return;
            }
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${ver}`,
              });
              core.setFailed(`tag already exists: ${ver}`);
              return;
            } catch (e) {
              // 404면 태그 없음 → 통과
              if (e.status !== 404) throw e;
            }

      # 2) 릴리즈 생성(태그 자동 생성)
      - name: Publish GitHub Release (auto-create tag)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}         # 없으면 자동 생성
          target_commitish: ${{ github.sha }}     # 현재 커밋에 태그
          body: ${{ inputs.notes }}
          generate_release_notes: true
