name: AK7 run (/ak only)

on:
  issue_comment:              { types: [created, edited] }
  pull_request_review_comment:{ types: [created, edited] }
  workflow_dispatch:
    inputs:
      issue_number: { description: "Issue/PR number", required: true }
      body:         { description: "Comment body to simulate", required: true }

permissions:
  contents: read
  issues: write
  pull-requests: write
  checks: write

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      body:  ${{ steps.out.outputs.body }}
      kind:  ${{ steps.out.outputs.kind }}
      issue: ${{ steps.out.outputs.issue }}
    steps:
      - id: out
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            body="${{ inputs.body }}"
            issue="${{ inputs.issue_number }}"
          else
            body="${{ github.event.comment.body }}"
            # 이슈/PR/리뷰댓글 모두 커버 (없으면 빈 값)
            issue="${{ github.event.issue.number || github.event.pull_request.number || github.event.comment.pull_request_url && github.event.pull_request.number }}"
          fi
          body="$(printf '%s' "$body" | sed -e 's/^[[:space:]]*//' )"
          echo "body=$body"  >> $GITHUB_OUTPUT
          kind=""
          [[ "$body" == /ak* ]] && kind="ak"
          echo "kind=$kind" >> $GITHUB_OUTPUT
          echo "issue=$issue">> $GITHUB_OUTPUT
      - name: Note
        run: echo "triggered: kind='${{ steps.out.outputs.kind }}' body='${{ steps.out.outputs.body }}' issue='${{ steps.out.outputs.issue }}'"

  ack:
    needs: gate
    if: ${{ needs.gate.outputs.kind == 'ak' }}
    runs-on: ubuntu-latest
    outputs:
      body:  ${{ steps.cap.outputs.body }}
      issue: ${{ needs.gate.outputs.issue }}
    steps:
      - id: cap
        run: echo "body=${{ needs.gate.outputs.body }}" >> $GITHUB_OUTPUT
      - uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const issue = Number("${{ needs.gate.outputs.issue }}");
            const body  = `${{ toJson(needs.gate.outputs.body) }}`.trim();
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: issue,
              body: `ack ✅ ${body}`
            });

  run:
    needs: ack
    runs-on: windows-latest
    if: ${{ needs.gate.outputs.kind == 'ak' }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse
        id: parse
        shell: pwsh
        run: |
          $p = "${{ needs.ack.outputs.body }}".Trim().Split(' ',[System.StringSplitOptions]::RemoveEmptyEntries)
          "cmd=$($p[1] ?? 'scan')"     | Out-File $env:GITHUB_OUTPUT -Append
          "mode=$($p[2] ?? 'preview')" | Out-File $env:GITHUB_OUTPUT -Append
          New-Item -ItemType File -Force .ak-out.txt | Out-Null

      - name: Run AK task
        id: runstep
        shell: pwsh
        env: { AK_MODE: ${{ steps.parse.outputs.mode }} }
        run: |
          Set-StrictMode -Version Latest; $ErrorActionPreference='Stop'
          $map=@{ scan='ak-scan.ps1'; rewrite='ak-rewrite.ps1'; fix='ak-fixloop.ps1'; test='ak-test.ps1'; fixloop='ak-fixloop.ps1' }
          $cmd='${{ steps.parse.outputs.cmd }}'
          if(-not $map.ContainsKey($cmd)){ "Unknown: $cmd" | Tee-Object .ak-out.txt -Append; exit 10 }

          $cand=@(
            Join-Path 'scripts/g5' $map[$cmd],
            Join-Path 'scripts'    $map[$cmd],
            $map[$cmd]
          ) | ? { Test-Path $_ } | Select-Object -First 1
          if(-not $cand){ "Script not found: $($map[$cmd])" | Tee-Object .ak-out.txt -Append; exit 11 }

          $supportsMode = try { (Get-Command $cand -ErrorAction Stop).Parameters.ContainsKey('Mode') } catch { $false }
          $args=@(); if($supportsMode){ $args += @('-Mode',$env:AK_MODE) }

          ">> Running $cand $args" | Tee-Object .ak-out.txt -Append
          try { & pwsh -NoProfile -File $cand @args 2>&1 | Tee-Object .ak-out.txt -Append; $code=$LASTEXITCODE }
          catch { $_ | Out-String | Tee-Object .ak-out.txt -Append; $code=1 }
          "exit_code=$code" | Out-File $env:GITHUB_OUTPUT -Append
          if($code -ne 0){ Write-Error "AK step failed with code $code" }

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ak7-logs
          path: |
            .ak-out.txt
            logs/**/*.log
          if-no-files-found: ignore

      - name: Reply with tail
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
        env:
          CMD:  ${{ steps.parse.outputs.cmd }}
          MODE: ${{ steps.parse.outputs.mode }}
        script: |
          const fs = require('fs');
          let tail='(no .ak-out.txt)'; try { tail = fs.readFileSync('.ak-out.txt','utf8').split('\n').slice(-100).join('\n'); } catch {}
          const issue = Number("${{ needs.ack.outputs.issue }}");
          await github.rest.issues.createComment({
            owner: context.repo.owner, repo: context.repo.repo,
            issue_number: issue,
            body: `✅ \`/ak\` done (${process.env.CMD} ${process.env.MODE})\n\n\`\`\`\n${tail}\n\`\`\``
          });
